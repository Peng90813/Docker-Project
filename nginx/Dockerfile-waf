# Use the Alpine base image for the builder stage
FROM alpine:latest AS builder

# 安装必要的依赖项，包括 linux-headers
RUN apk add --no-cache \
    pcre-dev \
    zlib-dev \
    openssl-dev \
    wget \
    git \
    build-base \
    brotli-dev \
    libxml2-dev \
    libxslt-dev \
    curl-dev \
    yajl-dev \
    lmdb-dev \
    geoip-dev \
    lua-dev \
    automake \
    autoconf \
    libtool \
    pkgconfig \
    linux-headers

# Set the working directory
WORKDIR /app

# Set the Nginx version as a build argument
ARG NGINX_VERSION=1.27.2

# Download and extract the specified version of Nginx
RUN wget https://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz && \
    tar -zxf nginx-${NGINX_VERSION}.tar.gz

# Clone the ngx_brotli module
RUN git clone --recurse-submodules -j8 https://github.com/google/ngx_brotli

# Clone and build libmodsecurity
RUN git clone --depth 1 https://github.com/SpiderLabs/ModSecurity /app/ModSecurity && \
    cd /app/ModSecurity && \
    git submodule init && \
    git submodule update && \
    ./build.sh && \
    ./configure && \
    make && make install

# Clone the ModSecurity-nginx connector
RUN git clone --depth 1 https://github.com/SpiderLabs/ModSecurity-nginx /app/ModSecurity-nginx

# Build the dynamic modules
RUN cd nginx-${NGINX_VERSION} && \
    ./configure --with-compat \
                --add-dynamic-module=../ngx_brotli \
                --add-dynamic-module=../ModSecurity-nginx && \
    make modules

# Use the official Nginx Alpine image for the final stage
FROM nginx:alpine

ARG NGINX_VERSION=1.27.2
# Copy the built modules from the builder stage
COPY --from=builder /app/nginx-${NGINX_VERSION}/objs/ngx_http_brotli_static_module.so /etc/nginx/modules/
COPY --from=builder /app/nginx-${NGINX_VERSION}/objs/ngx_http_brotli_filter_module.so /etc/nginx/modules/
COPY --from=builder /app/nginx-${NGINX_VERSION}/objs/ngx_http_modsecurity_module.so /etc/nginx/modules/

# 复制 libmodsecurity 目录下的所有文件到 /usr/lib/
COPY --from=builder /usr/local/modsecurity/lib/* /usr/lib/

# 创建配置目录
RUN mkdir -p /etc/nginx/modsec && \
    wget https://github.com/coreruleset/coreruleset/archive/v4.7.0.tar.gz && \
    tar -xzf v4.7.0.tar.gz --strip-components=1 -C /etc/nginx/modsec

RUN wget https://raw.githubusercontent.com/SpiderLabs/ModSecurity/v3/master/modsecurity.conf-recommended -O /etc/nginx/modsec/modsecurity.conf && \
    sed -i 's/SecRuleEngine DetectionOnly/SecRuleEngine On/' /etc/nginx/modsec/modsecurity.conf

RUN apk add lua5.1 lua5.1-dev pcre pcre-dev yajl yajl-dev  
RUN ldconfig /usr/lib
RUN wget https://raw.githubusercontent.com/SpiderLabs/ModSecurity/v3/master/unicode.mapping -O /etc/nginx/modsec/unicode.mapping